# 運用設計書 — PlanForge LG（MVP）

- 文書番号: PF-OPS-001
- 版数: v0.1
- 作成日: 2025-10-03
- 関連: PF-NFR-001, PF-SEC-001, PF-AUD-001, PF-ARCH-001, PF-API-001

------

## 1. 目的・適用範囲

本書は本番運用に必要な体制、手順、設定、監視、バックアップ、インシデント対応、変更管理を定義する。対象はアプリ/API/DB/オブジェクトストレージ/監査ログ/CI/CD。

------

## 2. 運用体制・責任分担（RACI）

| 項目             | 実施（R）  | 承認（A）        | 参照（C）         | 通知（I）  |
| ---------------- | ---------- | ---------------- | ----------------- | ---------- |
| 監視値の日次確認 | 運用担当   | 運用リード       | 開発              | 関係課     |
| 障害一次対応     | 運用担当   | 運用リード       | 開発/セキュリティ | 関係課     |
| 定期メンテナンス | 運用担当   | 運用リード       | 開発              | 全ユーザー |
| 権限付与/剥奪    | 運用担当   | 情報政策         | 監査              | 申請者     |
| 変更承認（本番） | 開発リード | プロダクト責任者 | 運用/監査         | 関係課     |
| 監査ログ閲覧     | 監査       | 情報政策         | 運用              | なし       |

------

## 3. 環境・構成管理

- 環境: `dev / stg / prod` を分離（ネットワーク/DB別）。
- 設定: すべて環境変数で管理（PF-ARCH-001 6.1参照）。
- 設定変更はPR＋レビューで履歴化。緊急時は変更申請書（簡易）を残す。
- シークレット管理: 環境ごとに保管庫。参照権限は最小限。

------

## 4. 定常運用作業

| 頻度   | 作業                                              | 判定基準/出力             |
| ------ | ------------------------------------------------- | ------------------------- |
| 日次   | 監視ダッシュボード確認（p95、エラー率、再試行率） | 閾値越え無しを記録        |
| 週次   | 脆弱性スキャン結果の確認                          | 高危険度0件（PF-NFR-001） |
| 週次   | バックアップ成否確認、復元テストスポット          | 成否ログ、サンプル復元OK  |
| 月次   | 権限棚卸（Owner/Editor/Viewer）                   | 不要アカウント解除        |
| 四半期 | DRドリル（RTO/RPO）                               | 目標値達成の証跡          |
| 随時   | 監査ログの抽出レポート配布                        | KPI/ブロック件数を共有    |

------

## 5. 監視・アラート

- 監視項目（例）
  - API p95応答時間（生成/検査/統合/試算/エクスポート）
  - エラー率、422率（スキーマ不整合）、レート制限発火回数
  - DB接続エラー、クエリ遅延、オブジェクト保存失敗
  - 署名URLの期限切れアクセス（403）
- アラート閾値（初期）
  - p95が目標の2倍超を5分継続
  - エラー率 > 2％（5分移動平均）
  - レート制限イベント多数（1分間に20回超）

------

## 6. バックアップ/DR

- DB: 日次スナップショット、保持7日（復元手順は手順書に従う）。
- オブジェクト（成果物・監査アセット）: バージョニング有効。
- RPO ≤ 24h、RTO ≤ 8h（PF-NFR-001準拠）。
- 復元手順の要点
  1. 影響範囲特定 → 2) 新規インスタンスへ復元 → 3) アプリを読み取り専用で起動 → 4) 整合確認 → 5) 通常運用へ切替。

------

## 7. インシデント対応

- 検知から2時間以内に初動（封じ込め・迂回策）。
- 24時間以内に再発防止案と暫定パッチ。
- 連絡順序: 運用担当 → 運用リード → プロダクト責任者/情報政策 → 関係課。
- 報告テンプレ（要点）
  - 概要、影響、発生/検知時刻、暫定対応、恒久対応、再発防止、監査ログの相関ID。

------

## 8. リリース/メンテナンス手順

- リリースフロー
  1. `stg` で回帰E2E合格（PF-QA-001）。
  2. 変更申請（差分・リスク・ロールバック手順）。
  3. ローリングデプロイ（2台）。
  4. ヘルスチェック通過後に完了通知。
- ロールバック
  - 直前イメージに切替、DBは後方互換の前提で前進修正を優先。
- 計画停止
  - 月1回、最大60分、3営業日前に告知（PF-NFR-001）。

------

## 9. アクセス管理

- 申請→承認→付与の3段階。申請書にプロジェクト範囲とロールを明記。
- 退職・異動時は当日中に無効化。
- 監査ログの閲覧は監査/情報政策に限定（PF-AUD-001）。

------

## 10. データ・出力の取り扱い

- P0は入力禁止または即時マスキング。
- 出力（md/docx）は署名付き短期URLで配布、有効期限既定15分。
- 公開用出力はP2のみ。公開判定は運用側で実施。

------

## 11. ハウスキーピング（保守ジョブ）

| 頻度 | ジョブ           | 内容                                      |
| ---- | ---------------- | ----------------------------------------- |
| 毎日 | 監査ログ圧縮     | 30日超のログを圧縮、365日超は要約のみ保持 |
| 毎日 | 辞書適用チェック | 未正規化語を抽出しレポート                |
| 毎日 | 孤立ノード検出   | 参照欠落ノードを抽出                      |
| 週次 | 成果物清掃       | 期限切れの署名URL、不要一時ファイルを削除 |

------

## 12. 変更管理（軽量版CAB）

- 変更種別
  - 標準: 既定手順でリスク低（定常メンテ）
  - 正常: 通常の機能変更（事前承認要）
  - 緊急: 障害復旧や重大脆弱性対応（事後承認可）
- 変更記録に含める項目
  - 目的、範囲、影響、リスク、ロールバック、実施者、承認者、監査ID。

------

## 13. SLA/サポート

- 問い合わせ一次応答: 営業時間内4h以内。
- 障害ステータスの公開: 主要障害はダッシュボードで掲示。
- エスカレーション: 重大度Sev1/2は即時エスカレーション。

------

## 14. 運用上のブロック条件（再掲）

- エクスポート時: P0残存、assumption/evidence欠落、脚注連番不整合、監査記録なし。
- ブロックは`result=blocked`で監査ログ記録（PF-AUD-001 7章）。

------

## 15. 受け入れ基準（運用）

- 監視・アラートが定義通り作動する（閾値試験）。
- バックアップからのサンプル復元成功（四半期）。
- 計画停止の告知→実施→復旧までの手順がドキュメント通り。
- 権限棚卸の実施証跡が残っている。
- インシデント演習を完了し、報告テンプレが運用可能。

------

## 16. 未確定事項

- 監査ログの正式保持年限（各団体規程に依存）。
- 外部共有の最終方針と公開承認フロー。
- メンテナンスウィンドウの曜日・時間帯（運用側で確定）。

------

## 17. 変更履歴

- v0.1（2025-10-03）初稿