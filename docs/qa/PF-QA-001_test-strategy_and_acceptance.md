# テスト戦略（受け入れ項目含む）— PlanForge LG（MVP）

- 文書番号: PF-QA-001
- 版数: v0.1
- 作成日: 2025-10-03
- 関連: PF-REQ-001, PF-NFR-001, PF-UC-001, PF-API-001, PF-DM-001, PF-UI-001, PF-SEC-001, PF-AUD-001

------

## 1. 目的

MVPの品質保証方針、テストレベル、観点、受け入れ基準、テストデータ、実行体制を定義する。

------

## 2. 品質目標（抜粋）

- 主要UCのE2E失敗率 0％（スモーク時）/ ≤2％（回帰全量）
- 生成・検査APIのJSONスキーマ不整合率 ≤0.5％
- 非機能（PF-NFR-001）のp95指標を全て満たす
- セキュリティ高危険度脆弱性 0件

------

## 3. テストレベルと目的

| レベル           | 目的                       | 代表ツール/方法                 |
| ---------------- | -------------------------- | ------------------------------- |
| 単体（UT）       | 関数・クラスのロジック検証 | xUnit, Property-based           |
| 結合（IT）       | APIとDB/辞書/監査の連携    | Testcontainers, Fixture         |
| 契約（Contract） | APIスキーマ整合、後方互換  | OpenAPI＋Schema Validator       |
| E2E              | 主要UCのブラウザ操作       | ヘッドレスE2E（例: Playwright） |
| パフォーマンス   | p95達成、スループット      | 負荷ツール、サンプル案件        |
| セキュリティ     | SAST/DAST、認可負テスト    | スキャナ＋手動                  |
| データ品質       | 前提・出典の紐付、辞書適用 | チェックバッチ                  |

------

## 4. テスト範囲（機能観点）

- Why入力/要約、追撃質問、ロジック生成・検査・パッチ、フレームワーク統合、試算、プレビュー、エクスポート、監査ログ、RBAC、P0ブロック

------

## 5. 受け入れ基準（シナリオ別）

### 5.1 スモーク（日次）

1. 新規プロジェクト作成→Why保存→要約生成が成功
2. ロジック生成→検査→パッチ適用→矛盾ゼロ
3. フレームワーク統合→1ページ要旨生成
4. 試算→SOM Low/Med/Highの算出
5. プレビュー→エクスポート（md/docx）成功、脚注連番一致
6. 監査ログに各操作が1件以上記録

### 5.2 回帰（リリース前）

- UC-01〜UC-08（PF-UC-001）を網羅。Given/When/Thenを自動テスト化。
- `GET /projects/:id/logic` / `GET /projects/:id/framework` / `GET /projects/:id/market` が保存済みデータを取得し、編集画面と整合すること。
- `POST /projects/:id/preview/synthesize` がschema適合レスポンス（sections/gaps/latency）を返し、失敗時は監査ログにSCHEMA_MISMATCHが残ること。
- ブロック条件3種: P0残存、assumption欠落、出典欠落でエクスポート拒否。

### 5.3 非機能

- p95: 出力プレビュー≤8秒、検査≤6秒、統合≤6秒、試算≤2秒
- 可用性ドリル: 単一APIインスタンス再起動でセッション維持（再ログイン不要でもよい）

### 5.4 セキュリティ

- 認可負テスト: viewerがエクスポート不可、editorが権限変更不可
- 直リンク防止: 署名URLの期限切れアクセスは403
- 入力検証: 比率>1で400、列挙外で400、JSONスキーマNGで422
- SAST/DAST: 高危険度ゼロ

### 5.5 データ品質

- 章ごとに`assumption_id[]`または`evidence_id[]`必須。欠落ゼロ
- 用語辞書未適用の生表現が0件（ビルド時）

------

## 6. テストケース設計（抜粋）

### 6.1 ロジック生成

- 正常: Why最小入力で第1階層3〜5本、`confidence`全ノード付与
- 異常: モデル出力が自然文混入→422→再試行→合格
- 異常: 同義語重複を含む→検査で`duplicates`提案返却

### 6.2 フレームワーク統合

- 正常: `normalized_terms`に「利用率→稼働率」
- 矛盾: PEST-S=需要増、KPI縮小→`conflicts`抽出

### 6.3 試算

- 正常: 入力レンジでLow/Med/High一致（算式検証）
- 異常: reach=1.2→400、エラーメッセージ明示

### 6.4 エクスポート

- 正常: md/docx生成、脚注連番、版・ハッシュ付与
- ブロック: P0検知、assumption欠落、出典欠落で拒否＋箇所特定

### 6.5 監査

- すべての主要操作で`audit_logs`に1件以上
- `result=blocked`の理由がpayloadに格納

### 6.6 プレビュー叙述

- 正常: `POST /projects/:id/preview/synthesize` が章配列と `gaps[]` を返し、`latency_ms` が記録される
- 異常: JSON Schema不整合時に`422`となり、`audit_logs.result=error`+`payload.error=SCHEMA_MISMATCH` が記録

### 6.7 Why項目CRUD

- 正常: 成功条件/制約/利害関係者で `POST`→`PATCH`→`DELETE` が順に成功し、`sort_order` の反映を確認
- 異常: 重複する `sort_order` や定義外 `stakeholder_category` で `VALIDATION_ERROR`

------

## 7. テストデータ

- サンプル案件3種（IdleAsset/Mobility/Childcare）
- ダミー統計値（範囲テスト用）、辞書初期データ、P0擬似文字列（検知テスト）
- ゴールデンファイル: 出力md/docx、ロジック検査結果JSON、試算結果JSON、プレビューsections JSON

------

## 8. 自動化と実行頻度

| 種別             | 実行タイミング | カバレッジ目安                 |
| ---------------- | -------------- | ------------------------------ |
| 単体             | PRごと         | 命令網羅60％＋分岐網羅40％以上 |
| 結合             | mainマージ時   | 主要API100％                   |
| E2Eスモーク      | 毎日深夜       | UCのハッピーパス               |
| 回帰E2E          | リリース前     | UC全量、ブロック条件含む       |
| 負荷             | 週次           | 代表シナリオ3本                |
| セキュリティSAST | PRごと         | 主要言語100％                  |
| セキュリティDAST | 週次           | 主要パス                       |

------

## 9. 不具合の重篤度

| Sev    | 説明                       | 例                         | 目標SLO    |
| ------ | -------------------------- | -------------------------- | ---------- |
| 1 重大 | データ破壊/漏えい/決裁不可 | エクスポート不能＋復旧不可 | 0件        |
| 2 高   | 主要UC不能                 | ロジック生成常時失敗       | 修正48h    |
| 3 中   | 代替手段あり               | プレビュー遅延             | 次リリース |
| 4 低   | 表示崩れ等                 | 軽微UI不具合               | 随時       |

------

## 10. リリースゲート（Go/No-Go）

- UC-01〜08のE2E合格
- p95性能閾値クリア
- SAST/DAST高危険度0件
- 監査ログから出力段落→前提・出典→生成履歴のトレース成功
- 既知不具合はSev3以下、回避策明示

------

## 11. 体制・責任

- QAリード: 計画・レビュー・最終承認
- 開発: UT/IT作成、回帰修正
- プロダクト: 受け入れ基準の承認、Go/No-Go判定
- セキュリティ: SAST/DAST運用、脆弱性対応

------

## 12. 変更履歴

- v0.1（2025-10-03）初稿
