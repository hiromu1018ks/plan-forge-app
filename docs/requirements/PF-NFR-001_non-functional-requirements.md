# 非機能要件定義書 — PlanForge LG（事業計画ドリルダウン生成器）

- 文書番号: PF-NFR-001  
- 版数: v0.1  
- 作成日: 2025-10-03  
- 対象リリース: MVP  
- 関連: PF-REQ-001（機能要件）

---

## 1. 目的・適用範囲
本書はMVPの非機能要件を定義する。対象はアプリ全体（Front/Back/DB/LLM推論、エクスポート機能、監査ログ）と運用。

---

## 2. 用語
- p95: 95パーセンタイル応答時間  
- RTO/RPO: 復旧時間目標/復旧時点目標  
- PII: 個人情報  
- RBAC: ロールベースアクセス制御

---

## 3. 可用性・信頼性
| 項目           | 要件                                                         |
| -------------- | ------------------------------------------------------------ |
| サービス可用性 | 営業時間帯（平日9–18時 JST）で月間稼働率≥99.5%               |
| 計画停止       | 月1回・最大60分、3営業日前告知                               |
| 障害時フェイル | 単一インスタンス障害でバックエンド自動再起動。DBは単一AZでよい（MVP） |
| データ永続化   | トランザクション完了時に永続化、監査ログは非同期でも最終的整合性を保証 |

---

## 4. 性能・スケーラビリティ
| ユースケース                      | 指標    | 目標値（p95）       |
| --------------------------------- | ------- | ------------------- |
| 出力プレビュー生成（章立て）      | API応答 | ≤ 8秒               |
| ロジック検査（MECE/矛盾）         | API応答 | ≤ 6秒               |
| フレームワーク統合（1ページ要旨） | API応答 | ≤ 6秒               |
| TAM/SAM/SOM計算                   | API応答 | ≤ 2秒               |
| 画面初期表示                      | LCP     | ≤ 2.5秒（有線相当） |

その他:
- 同時編集者5名/プロジェクトで性能劣化なし（MVPの上限）
- 1プロジェクト当たり文書出力フルビルド≤ 20秒（サーバ側）

---

## 5. セキュリティ
| 項目         | 要件                                                         |
| ------------ | ------------------------------------------------------------ |
| 認証         | アプリ内アカウント（MVP）。2要素はv1で検討                   |
| 認可         | プロジェクト単位RBAC（Owner/Editor/Viewer）                  |
| 通信         | TLS 1.2+                                                     |
| 保存時暗号化 | DB/オブジェクトストレージのサーバサイド暗号化                |
| 監査         | すべてのAI入出力、エクスポート操作、権限変更を監査ログに記録 |
| PII          | 入力フィールド単位でマスキング設定可。既定はPII無効化        |
| 依存性       | 週次で脆弱性スキャン（高深刻度は7日以内に対応）              |
| レート制限   | IP/ユーザー単位でAPIレート制限（初期値: 60 req/分）          |

---

## 6. コンプライアンス・記録管理
- 監査ログ保持期間: 最低1年（システム固定、コンプライアンス要件）。自治体の規程でより長期の設定も可能。削除要求に応じ匿名化可。
- 成果物・プロジェクトデータの保存年限: 自治体ごとに設定可能。既定値は運用設計書で定義（未確定）。
- 生成文書の版管理: エクスポートごとにハッシュ付与。
- 引用・出典: 出力内に脚注IDと出典URLを自動付加（AI補完は「要出典」表示）。

---

## 7. 可観測性・運用
| 項目           | 要件                                                         |
| -------------- | ------------------------------------------------------------ |
| ログ           | 構造化ログ（JSON）。相関IDでトレーシング                     |
| メトリクス     | API応答時間、LLM呼び出し回数/失敗率、エクスポート時間、DBクエリ時間 |
| アラート       | 5分平均エラー率>2%、または主要API p95>二倍閾値で通知         |
| ダッシュボード | 主要KPIを可視化（SLO達成率、失敗率）                         |

---

## 8. バックアップ/DR
| 項目         | 要件                                                         |
| ------------ | ------------------------------------------------------------ |
| バックアップ | DB日次スナップショット（保持7日）。オブジェクトはバージョニング |
| RPO          | ≤ 24時間                                                     |
| RTO          | ≤ 8時間                                                      |
| 復旧手順     | 手順書を別紙で用意（四半期ごとにドリル）                     |

---

## 9. アクセシビリティ・国際化
- アクセシビリティ: フォーム操作とコントラスト比をWCAG 2.2 Level AA相当（MVP範囲）  
- 言語: UIは日本語固定（MVP）。出力文書は日本語。桁区切り・単位はJIS表記

---

## 10. 互換性・クライアント環境
- ブラウザ: 最新版のChromium系/Firefox/Safari（2世代サポート）  
- 画面幅: 1280px以上を最適化対象。モバイル最適化は範囲外（MVP）  
- フォント: 日本語表示崩れがないこと

---

## 11. エクスポート品質
- Markdown→docx変換のレイアウト崩れ0件（審査用サンプル10件で確認）  
- 図（Mermaid→SVG/PNG）で文字切れ・重なり率0%（既定テーマ）  
- 脚注番号の連番整合（全章）必須

---

## 12. 監査ログ仕様（要点）
最低項目:
- `timestamp`, `actor_id`, `project_id`, `action`, `result`  
- AI関連: `model_id`, `prompt_id`, `input_hash`, `output_hash`, `tokens_in/out`, `latency_ms`, `confidence_summary`  
- エクスポート: `artifact_type`, `hash`, `sections`, `assumptions_bound[]`  
保存先: 書換不可ストレージ（WORM相当。MVPは追記専用S3互換で代替可）

---

## 13. 容量見積り（MVP）
- 1プロジェクトあたり: テキスト10万字、SVG/PNG計30枚、監査ログ数百KB  
- 初期: 50プロジェクト、総計≒ 2〜3GB

---

## 14. 非機能の受け入れ基準（抜粋）
- 可用性: 対象期間で稼働率≥99.5%の実測またはシミュレートで検証  
- 性能: 表4の各目標をサンプル案件3種でp95クリア  
- セキュリティ: 脆弱性スキャンで高深刻度0件、主要OWASP項目の動作確認  
- 監査: 任意の出力に対して、対応する監査ログからトレース可能  
- DR: 復旧手順実施でRTO/RPOを満たすこと

---

## 15. リスクと緩和
| リスク           | 影響           | 緩和策                                   |
| ---------------- | -------------- | ---------------------------------------- |
| LLM遅延          | UX劣化         | 非同期化、プログレス表示、結果キャッシュ |
| 監査ログ肥大     | ストレージ圧迫 | ローテーションと圧縮、サマリと原文の分離 |
| エクスポート崩れ | 品質低下       | サンプルでゴールデンテスト、テンプレ固定 |

---

## 16. 変更履歴
- v0.1（2025-10-03）初稿