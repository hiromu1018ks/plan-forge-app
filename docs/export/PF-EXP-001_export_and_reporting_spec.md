# エクスポート・帳票設計 — PlanForge LG（MVP）

- 文書番号: PF-EXP-001
- 版数: v0.1
- 作成日: 2025-10-03
- 関連: PF-REQ-001, PF-API-001, PF-DM-001, PF-UI-001, PF-AUD-001, PF-SEC-001

------

## 1. 目的・範囲

- 事業計画の**Markdown/Word(docx)** 出力、および図表（Mermaid→SVG/PNG）の組版仕様を定義する。
- PPTXはMVP対象外。章立て・脚注・付録・未確定表示・版管理をカバー。

------

## 2. 出力形式と構成

- 形式: `md`（主）、`docx`（審査用）。
- 文字コード: UTF-8。改行はLF。
- 章立て（既定、必要に応じ差替可）
  1. 表紙（タイトル、版、日付、作成者）
  2. ミッション・実現したい世界観
  3. 顧客課題・ペイン
  4. アプローチ（価値提案・施策）
  5. サービス/プロダクト概要
  6. 収益/費用モデル
  7. トラクション/KPI 現状（任意）
  8. 市場規模（TAM/SAM/SOM）
  9. 競合状況・ポジショニング
  10. コスト構造・CF概観（任意）
  11. 事業戦略・ロードマップ
  12. 3カ年計画（KGI/KPI）
  13. 必要リソース・体制
  14. リスクと対応
  15. 付録（出典・前提・想定問答）

------

## 3. Markdown テンプレ（抜粋）

- すべての段落は `assumption_id[]` または `evidence_id[]` を保持。欠落時はビルド不可。

```
# {タイトル}
版: {version} / 日付: {date} / 作成: {author}

## 1. ミッション
{body_md}
[^E-001]: {citation_text}

## 2. 顧客課題
{body_md}

## 8. 市場規模（TAM/SAM/SOM）
- TAM: {tam}
- SAM: {sam}
- SOM: Low {som.low} / Med {som.med} / High {som.high}
> 前提: {assumption_ids.join(", ")}

## 15. 付録
### 15.1 出典一覧
- [^E-001] 書誌/URL...
```

------

## 4. docx 変換仕様

- 変換エンジン: Pandoc相当の想定。
- スタイルマッピング（既定テンプレ）
  - `#` → Heading 1、`##` → Heading 2、`###` → Heading 3
  - 箇条書き → List Bullet 1/2
  - 表 → Table Grid（日本語フォント指定）
- 余白: 上下25mm 左右20mm。
- フォント: 本文 10.5pt 相当。
- ヘッダ/フッタ: 版番号・ページ番号を右下。
- 画像のサイズ: 幅は本文幅の90％上限、縦横比維持。
- 脚注はdocxのFootnoteとして配置。番号はMarkdown順に連番。

------

## 5. 図表レンダリング

- ロジックツリーなどの図は**Mermaid記法**を生成し、サーバ側で**SVG**を作る。
- PNGは閲覧系互換のための副次出力（必要時）。
- フォント埋め込み可否で文字化けが出る環境向けにアウトライン化設定を保持。
- 文字切れ回避の最小ルール
  - 最大ノード幅を400px、行長40字程度で自動折返し
  - ラベル内改行は `\n` 許可
  - 日本語フォントのフォールバック指定

------

## 6. 脚注・出典・前提の扱い

- 出典: `[^E-xxx]`。EvidenceテーブルのIDと一致。
- 前提: 段落末に `> 前提: A-001, A-004` を付記。
- AI補完の断定禁止。`confidence="low"` のものは本文に `[未確定]` を併記。
- 出典が未確定の記述は**要出典**タグを付け、エクスポート時に検知対象。

------

## 7. ブロック条件（ビルド拒否）

- P0残存（PIA定義に基づく）。
- `assumption_id[]` または `evidence_id[]` の欠落。
- Assumptionに紐づくEvidence（`assumption_sources`）が0件（要出典状態の残存）。
- 章番号の不整合（抜け・重複）。
- 監査ログ未記録（主要操作）。
- これらはビルドを停止し、該当箇所をハイライトしたプレビューへ戻す。

------

## 8. 版管理・ハッシュ

- 版: `v{major}.{minor}`。MVPは自動で `minor` を+1。
- ハッシュ: 生成文書のSHA-256。監査ログに `output_hash` を保存。
- ダウンロードURLは署名付き短期URL（有効期限既定15分）。

------

## 9. セクション別生成規則（要点）

- 1. 顧客課題: 問題→影響→対象の順。1段落ずつ。
- 1. アプローチ: 施策は3件まで、優先度と採否理由を短文で。
- 1. 市場規模: 定義式を明記。レンジ値はLow/Med/Highで表。
- 1. 3カ年計画: 年次KGI/KPIの表。式、単位、算出根拠を併記。
- 1. リスク: 発生確率・影響・対応・残余を1行表で。

------

## 10. スタイル・表記

- 日本語。常体。冗長な修飾は削除。
- 単位はJIS慣行（%は半角、面積は㎡、金額は万円/億円）。
- 用語は辞書で正規化（例: 利用率→稼働率）。
- 数式はインラインで記述（例: `SOM = SAM × 到達 × 転換 × 利用回数`）。

------

## 11. エクスポートAPI（仕様再掲）

- `POST /api/projects/:id/export`
  - 入力: `format: md|docx`, `sections?: string[]`
  - 検査: ブロック条件・脚注連番・章番号
  - 応答: `artifact_id, version, hash, download_url`
- 監査: `export_md`/`export_docx` を記録。`sections[]` と `output_hash` を保存。

------

## 12. サンプル章テンプレ（最小）

- 本番テンプレはリポジトリの `templates/export/default.md.tmpl` に配置。

```
# {{ project.title }}
版: {{ artifact.version }} / 日付: {{ now }} / 作成: {{ actor.name }}

## 1. ミッション
{{ sections.mission.body_md }}

## 2. 顧客課題
{{ sections.problem.body_md }}

## 8. 市場規模
- TAM: {{ market.tam }}
- SAM: {{ market.sam }}
- SOM: Low {{ market.som.low }}, Med {{ market.som.med }}, High {{ market.som.high }}
> 前提: {{ market.assumptions | join(", ") }}

## 15. 付録
### 15.1 出典一覧
{{#each evidence}}
- [^{{ this.id }}]: {{ this.citation }}
{{/each}}
```

------

## 13. 品質基準

- 章見出しの連番・目次リンクが一致。
- 脚注IDの未参照・重複が0件。
- 図の文字切れ0件。
- 出力間での差分が構造化比較で安定（見出し・脚注・図の順序差分のみ）。

------

## 14. テスト観点

- ブロック条件発火の網羅（P0、assumption、evidence、番号不整合）。
- docxの表組・脚注位置が既定テンプレと一致。
- Mermaid→SVGのフォント崩れがない。
- 版番号とハッシュが監査ログの値と一致。

------

## 15. 未確定

- docxテンプレの正式フォント指定（自治体標準に合わせる）。
- 図の色覚対応テーマ詳細。
- 英文版テンプレ（v1以降）。

------

## 16. 変更履歴

- v0.1（2025-10-03）初稿